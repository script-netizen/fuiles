<html><head><base href="https://towerdefense-evolved.com/" /><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Enhanced Tower Defense Game</title><style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #2c3e50;
        font-family: 'Arial', sans-serif;
        color: #ecf0f1;
    }
    #gameCanvas {
        border: 2px solid #34495e;
        box-shadow: 0 0 10px rgba(52, 73, 94, 0.5);
    }
    #gameInfo {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(44, 62, 80, 0.8);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
        overflow: hidden;
        transform-origin: top left;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    #gameInfo.collapsed {
        transform: translateX(-100%) translateX(25px);
    }
    #gameInfo:hover,
    #gameInfo.force-show {
        transform: none !important;
    }
    #toggleStatsMenu {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(44, 62, 80, 0.8);
        border: none;
        color: #ecf0f1;
        font-size: 18px;
        cursor: pointer;
        z-index: 5;
        padding: 5px 8px;
        border-radius: 0 5px 5px 0;
        transition: all 0.3s ease;
    }
    #toggleStatsMenu:hover {
        background-color: rgba(44, 62, 80, 1);
    }
    #gameInfo p {
        margin: 5px 0;
        font-size: 16px;
    }
    #gameInfo span {
        font-weight: bold;
        color: #3498db;
    }
    #waveMessage {
        color: #2ecc71;
        font-weight: bold;
        margin-top: 10px;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    #towerInfo {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(44, 62, 80, 0.9);
        padding: 15px; 
        border-radius: 10px;
        display: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        color: #ecf0f1;
        min-width: 200px;
    }
    #towerInfo h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #3498db;
    }
    .tower-stats p, .upgrade-info p {
        margin: 5px 0;
    }
    .tower-stats strong, .upgrade-info strong {
        color: #e67e22;
    }
    .upgrade-info {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(236, 240, 241, 0.2);
    }
    #upgradeTower, #sellTower {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        font-size: 16px;
        font-weight: bold;
        color: #ecf0f1;
        background-color: #2980b9;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    #upgradeTower:hover, #sellTower:hover {
        background-color: #3498db;
    }
    #upgradeTower:disabled {
        background-color: #34495e;
        cursor: not-allowed;
    }
    #maxLevelMessage {
        color: #e74c3c;
        font-weight: bold;
        margin-top: 10px;
        display: none;
    }
    #towerSelector {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(44, 62, 80, 0.9);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 20px;
        transition: transform 0.3s ease;
    }
    .tower-button {
        background-color: rgba(52, 73, 94, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #ecf0f1;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .tower-button .tower-icon {
        width: 40px;
        height: 40px;
    }
    .tower-info {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 10px;
        border-radius: 8px;
        width: 150px;
        display: none;
        text-align: center;
        margin-bottom: 10px;
    }
    .tower-button:hover .tower-info {
        display: block;
    }
    .tower-info h4 {
        margin: 0 0 5px 0;
        color: #3498db;
    }
    .tower-info p {
        margin: 2px 0;
        font-size: 12px;
    }
    #towerSelector.collapsed {
        transform: translateY(100%);
    }
    #restartButton, #startWave, #enemyInfoButton, #pauseButton {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin: 5px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 0.5px;
        width: 100%;
    }
    #restartButton {
        margin-top: 10px;
    }
    #enemyInfoButton {
        background-color: #3498db;
    }
    #enemyInfoButton:hover {
        background-color: #2980b9;
    }
    #startWave {
        background-color: #2ecc71;
        margin-top: 10px;
        width: 100%;
    }
    #startWave:hover {
        background-color: #27ae60;
    }
    #enemyInfo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.9);
        padding: 20px;
        border-radius: 10px;
        display: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 10;
    }
    #enemyInfo h3 {
        margin-top: 0;
    }
    .enemy-types {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    .enemy-type {
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        cursor: pointer;
        position: relative;
    }
    .enemy-icon {
        width: 30px;
        height: 30px;
    }
    .enemy-details {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 10px;
        border-radius: 5px;
        width: 200px;
        text-align: center;
        z-index: 1;
        margin-top: 5px;
    }
    .enemy-type:hover .enemy-details {
        display: block;
    }
    .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #ecf0f1;
        font-size: 20px;
        cursor: pointer;
    }
    #maxLevelMessage {
        color: #e74c3c;
        font-weight: bold;
        margin-top: 10px;
        display: none;
    }
    #upgradeTower {
        background-color: #f39c12;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #upgradeTower:hover {
        background-color: #e67e22;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    #upgradeTower:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #upgradeTower::before {
        content: 'â†‘';
        margin-right: 5px;
        font-size: 18px;
    }
    #sellTower {
        background-color: #e74c3c;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #sellTower:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    #sellTower:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #gameOverMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.9);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 100;
    }
    #gameOverMessage h2 {
        color: #e74c3c;
        font-size: 24px;
        margin-bottom: 20px;
    }
    #playAgainButton {
        background-color: #2ecc71;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.3s;
    }
    #playAgainButton:hover {
        background-color: #27ae60;
    }
    .tower-upgrade-modal {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 100;
    }
    .upgrade-option {
        background-color: #34495e;
        border: none;
        color: #ecf0f1;
        padding: 15px;
        margin: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 200px;
    }
    .upgrade-option:hover {
        background-color: #2c3e50;
    }
    #devPanel {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 20px;
        border-radius: 10px;
        z-index: 1000;
    }
    #devPanel button {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 10px;
        background-color: #34495e;
        border: none;
        color: #ecf0f1;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #devPanel button:hover {
        background-color: #2c3e50;
    }
    
    #toggleTowerMenu {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(44, 62, 80, 0.9);
        color: #ecf0f1;
        border: none;
        padding: 8px;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-size: 18px;
        z-index: 5;
    }
    #difficultySelectionMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: block;
        z-index: 100;
    }
    #difficultySelectionMenu button {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 10px;
        background-color: #34495e;
        border: none;
        color: #ecf0f1;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #difficultySelectionMenu button:hover {
        background-color: #2c3e50;
    }
    /* Add styles for the map selection menu */
    #mapSelectionMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(44, 62, 80, 0.95);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 100;
    }
    #mapSelectionMenu button {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 10px;
        background-color: #34495e;
        border: none;
        color: #ecf0f1;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #mapSelectionMenu button:hover {
        background-color: #2c3e50;
    }
    #pauseButton {
        background-color: #9b59b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin: 5px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 0.5px;
        width: 100%;
    }
    #pauseButton:hover {
        background-color: #8e44ad;
    }
</style></head><body>
<div id="difficultySelectionMenu">
    <h2>Select Difficulty</h2>
    <button id="easyDifficulty">Easy</button>
    <button id="normalDifficulty">Normal</button>
    <button id="hardDifficulty">Hard</button>
</div>
<div id="mapSelectionMenu" style="display: none;">
    <h2>Select Map</h2>
    <button id="map1">Map 1</button>
    <button id="map2">Map 2</button>
    <button id="map3">Map 3</button>
</div>
<button id="toggleTowerMenu" class="toggle-button">&#x25B2;</button>
<div id="gameInfo">
    <button id="toggleStatsMenu" class="toggle-button">&#x25B6;</button>
    <p>Money: <span id="money">100</span></p>
    <p>Lives: <span id="lives">20</span></p>
    <p>Wave: <span id="wave">1</span></p>
    <p>Enemies to kill: <span id="enemiesToKill">10</span></p>
    <p id="waveMessage"></p>
    <button id="startWave">Start Wave</button>
    <button id="restartButton">Restart Game</button>
    <button id="enemyInfoButton">Enemy Info</button>
    <button id="pauseButton">Pause</button>
</div>
<div id="towerInfo">
    <h3>Tower Stats</h3>
    <div class="tower-stats">
        <p><strong>Type:</strong> <span id="towerType"></span></p>
        <p><strong>Damage:</strong> <span id="towerDamage"></span></p>
        <p><strong>Range:</strong> <span id="towerRange"></span></p>
        <p><strong>Cooldown:</strong> <span id="towerCooldown"></span>s</p>  
        <p><strong>Level:</strong> <span id="towerLevel"></span></p>
        <p><strong>Special:</strong> <span id="towerSpecial"></span></p>
    </div>
    <div class="upgrade-info">
        <p><strong>Upgrade Cost:</strong> <span id="towerUpgradeCost"></span></p>
        <button id="upgradeTower">Upgrade</button>
        <p id="maxLevelMessage">Max Level Reached!</p>
    </div>
    <button id="sellTower">Sell</button>
</div>
<div id="towerSelector">
    <button class="tower-button" id="basicTower">
        <svg class="tower-icon" viewBox="0 0 100 100">
            <rect x="25" y="25" width="50" height="50" fill="#3498db"/>
        </svg>
        <div class="tower-info">
            <h4>Basic Tower</h4>
            <p>Cost: <span id="basicTowerCost">50</span></p>
            <p>Balanced tower with moderate range and damage</p>
        </div>
    </button>
    <button class="tower-button" id="sniperTower">
        <svg class="tower-icon" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="25" fill="#2ecc71"/>
        </svg>
        <div class="tower-info">
            <h4>Sniper Tower</h4>
            <p>Cost: <span id="sniperTowerCost">100</span></p>
            <p>Long range with high single-target damage</p>
        </div>
    </button>
    <button class="tower-button" id="shotgunTower">
        <svg class="tower-icon" viewBox="0 0 100 100">
            <path d="M50 10 L90 35 L90 65 L50 90 L10 65 L10 35 Z" fill="#e67e22"/>
        </svg>
        <div class="tower-info">
            <h4>Shotgun Tower</h4>
            <p>Cost: <span id="shotgunTowerCost">75</span></p>
            <p>Short range with multiple projectiles</p>
        </div>
    </button>
    <button class="tower-button" id="alchemistTower">
        <svg class="tower-icon" viewBox="0 0 100 100">
            <rect x="35" y="35" width="30" height="30" transform="rotate(45 50 50)" fill="#8e44ad"/>
        </svg>
        <div class="tower-info">
            <h4>Alchemist Tower</h4>
            <p>Cost: <span id="alchemistTowerCost">75</span></p>
            <p>Boosts the damage and range of nearby towers</p>
        </div>
    </button>
    <button class="tower-button" id="factoryTower">
        <svg class="tower-icon" viewBox="0 0 100 100">
            <rect x="20" y="30" width="60" height="40" fill="#16a085"/>
            <rect x="35" y="20" width="30" height="20" fill="#27ae60"/>
            <circle cx="30" cy="50" r="5" fill="#2ecc71"/>
            <circle cx="70" cy="50" r="5" fill="#2ecc71"/>
        </svg>
        <div class="tower-info">
            <h4>Factory Tower</h4>
            <p>Cost: <span id="factoryTowerCost">150</span></p>
            <p>Generates cash over time</p>
        </div>
    </button>
</div>
<div id="enemyInfo">
    <button class="close-button">&times;</button>
    <h3>Enemy Types</h3>
    <div class="enemy-types">
        <div class="enemy-type">
            <div class="enemy-icon" style="background-color: red; border-radius: 50%;"></div>
            <div class="enemy-details">
                <h4>Normal</h4>
                <p>Health: <span id="normalEnemyHealth">50</span></p>
                <p>Current Health: <span id="normalEnemyCurrentHealth">50</span></p>
                <p>Speed: Normal</p>
            </div>
        </div>
        <div class="enemy-type">
            <div class="enemy-icon" style="background-color: yellow; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
            <div class="enemy-details">  
                <h4>Fast</h4>
                <p>Health: <span id="fastEnemyHealth">30</span></p>
                <p>Current Health: <span id="fastEnemyCurrentHealth">30</span></p>
                <p>Speed: 2x Normal</p>
            </div>
        </div>
        <div class="enemy-type">  
            <div class="enemy-icon" style="background-color: purple; width: 30px; height: 30px;"></div>
            <div class="enemy-details">
                <h4>Tank</h4>
                <p>Health: <span id="tankEnemyHealth">100</span></p>
                <p>Current Health: <span id="tankEnemyCurrentHealth">100</span></p>
                <p>Speed: 0.5x Normal</p>  
            </div>
        </div>
        <div class="enemy-type">
            <div class="enemy-icon" style="background-color: orange; border-radius: 50%; border: 4px dashed black;"></div>  
            <div class="enemy-details">
                <h4>Fortified</h4>
                <p>Health: <span id="fortifiedEnemyHealth">80</span></p>
                <p>Current Health: <span id="fortifiedEnemyCurrentHealth">80</span></p>
                <p>Speed: Normal</p>
                <p>Takes reduced damage from towers</p>
            </div>
        </div>
        <div class="enemy-type">
            <div class="enemy-icon" style="background-color: cyan; clip-path: polygon(20% 0%, 0% 20%, 30% 50%, 0% 80%, 20% 100%, 50% 70%, 80% 100%, 100% 80%, 70% 50%, 100% 20%, 80% 0%, 50% 30%);"></div>
            <div class="enemy-details">  
                <h4>Dodger</h4>
                <p>Health: <span id="dodgerEnemyHealth">40</span></p>  
                <p>Current Health: <span id="dodgerEnemyCurrentHealth">40</span></p>
                <p>Speed: 1.5x Normal</p>
                <p>Chance to dodge incoming projectiles</p>  
            </div>
        </div>
    </div>
</div>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="gameOverMessage">
    <h2>Game Over!</h2>
    <button id="playAgainButton">Play Again</button>
</div>
<div class="tower-upgrade-modal" id="sniperUpgradeModal">
    <h2>Choose Sniper Upgrade Path</h2>
    <button class="upgrade-option" id="laserUpgrade">
        Laser Rifle
        <br>
        -20% Fire Rate
        <br>
        +50% Damage
        <br>
        Pierce Enemies
    </button>
    <button class="upgrade-option" id="sharpshooterUpgrade">
        Sharpshooter
        <br>
        -20% Damage
        <br>
        +50% Fire Rate
        <br>
        Increased Crit
    </button>
</div>
<div class="tower-upgrade-modal" id="basicUpgradeModal">
    <h2>Choose Basic Upgrade Path</h2>
    <button class="upgrade-option" id="rapidfireUpgrade">
        Rapid Fire
        <br>
        +50% Fire Rate
        <br>
        -20% Damage
    </button>
    <button class="upgrade-option" id="heavyUpgrade">
        Heavy Bullets
        <br>
        +50% Damage 
        <br>
        -20% Fire Rate
    </button>
</div>
<div class="tower-upgrade-modal" id="shotgunUpgradeModal">
    <h2>Choose Shotgun Upgrade Path</h2>
    <button class="upgrade-option" id="spreadUpgrade">  
        Wider Spread
        <br>
        +50% Spread Angle
        <br> 
        -20% Damage
    </button>
    <button class="upgrade-option" id="slugUpgrade">
        Slugs
        <br>
        +50% Damage
        <br>
        -20% Bullet Count  
    </button>
</div>
<div class="tower-upgrade-modal" id="alchemistUpgradeModal">
    <h2>Choose Alchemist Upgrade Path</h2> 
    <button class="upgrade-option" id="stimulantUpgrade">
        Stimulant
        <br>
        +50% Boost Percentage
        <br>
        -20% Range  
    </button>
    <button class="upgrade-option" id="radiusUpgrade">
        Radius
        <br> 
        +50% Range
        <br>
        -20% Boost Percentage
    </button>
</div>
<div id="devPanel">
    <h3>Developer Panel</h3>
    <label for="setMoney">Set Money:</label>
    <input type="number" id="setMoney" value="100">
    <button id="setMoneyButton">Set</button>
    <br>
    <label for="setLives">Set Lives:</label>
    <input type="number" id="setLives" value="20">
    <button id="setLivesButton">Set</button>
    <br>
    <label for="setWave">Set Wave:</label>
    <input type="number" id="setWave" value="1">
    <button id="setWaveButton">Set</button>
    <br>
    <button id="toggleInfiniteLives">Toggle Infinite Lives</button>
    <button id="skipWave">Skip Wave</button>
    <button id="upgradeAllTowers">Upgrade All Towers</button>
    <button id="closeDevPanel">Close</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let difficulty = 'normal';
let enemySpeedModifier = 1;
let enemyHealthModifier = 1;
let towerCostModifier = 1;

let money = 100;
let lives = 20;
let wave = 1;
let enemies = [];
let towers = [];
let bullets = [];
let selectedTower = null;
let placingTower = null;
let mouseX = 0;
let mouseY = 0;
let path = [
    {x: 0, y: 100},
    {x: 700, y: 100},
    {x: 700, y: 500},
    {x: 100, y: 500},
    {x: 100, y: 300},
    {x: 800, y: 300}
];
let gamePaused = true;
let gameOver = false;
let enemySpawnInterval = null;
let enemiesSpawned = 0;
let enemiesToKill = 10;
let totalEnemiesToSpawn = 10;

let konamiCode = [',']; 
let konamiIndex = 0;
let devMode = false;

function isOnPath(x, y, buffer = 30) {
    for (let i = 0; i < path.length - 1; i++) {
        let start = path[i];
        let end = path[i + 1];
        
        let d = distanceToSegment(x, y, start.x, start.y, end.x, end.y);
        
        if (d < buffer) {
            return true;
        }
    }
    return false;
}

function distanceToSegment(px, py, x1, y1, x2, y2) {
    let A = px - x1;
    let B = py - y1;
    let C = x2 - x1;
    let D = y2 - y1;

    let dot = A * C + B * D;
    let len_sq = C * C + D * D;
    let param = -1;

    if (len_sq !== 0) {
        param = dot / len_sq;
    }

    let xx, yy;

    if (param < 0) {
        xx = x1;
        yy = y1;
    } else if (param > 1) {
        xx = x2;
        yy = y2;
    } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
    }

    let dx = px - xx;
    let dy = py - yy;

    return Math.sqrt(dx * dx + dy * dy);
}

function isTowerOverlap(x, y, buffer = 40) {
    return towers.some(tower => {
        let dx = tower.x - x;
        let dy = tower.y - y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        return distance < buffer;
    });
}

function getTowerCost(towerType) {
    let cost = 0;
    switch(towerType) {
        case 'basic':
            cost = 50;
            break;
        case 'sniper':
            cost = 100;
            break;
        case 'shotgun':
        case 'alchemist':
            cost = 75;
            break;
        case 'factory': // Added case for Factory Tower
            cost = 150;
            break;
    }
    return Math.floor(cost * towerCostModifier);
}

function updateTowerCosts() {
    document.getElementById('basicTowerCost').textContent = getTowerCost('basic');
    document.getElementById('sniperTowerCost').textContent = getTowerCost('sniper');
    document.getElementById('shotgunTowerCost').textContent = getTowerCost('shotgun');
    document.getElementById('alchemistTowerCost').textContent = getTowerCost('alchemist');
    document.getElementById('factoryTowerCost').textContent = getTowerCost('factory');
}

const toggleTowerMenuButton = document.getElementById('toggleTowerMenu');
const towerSelector = document.getElementById('towerSelector');

toggleTowerMenuButton.addEventListener('click', () => {
    towerSelector.classList.toggle('collapsed');
    if (towerSelector.classList.contains('collapsed')) {
        toggleTowerMenuButton.innerHTML = '&#x25BC;'; 
    } else {
        toggleTowerMenuButton.innerHTML = '&#x25B2;'; 
    }
});

const toggleStatsMenuButton = document.getElementById('toggleStatsMenu');
const gameInfo = document.getElementById('gameInfo');

toggleStatsMenuButton.addEventListener('click', () => {
    gameInfo.classList.toggle('collapsed');
    if (gameInfo.classList.contains('collapsed')) {
        toggleStatsMenuButton.innerHTML = '&#x25B6;'; 
    } else {
        toggleStatsMenuButton.innerHTML = '&#x25C0;'; 
    }
});

document.addEventListener('mousemove', function(e) {
    const gameInfo = document.getElementById('gameInfo');
    const rect = gameInfo.getBoundingClientRect();
    const buffer = 50; 

    if (e.clientX < (rect.right + buffer) && e.clientY < (rect.bottom + buffer)) {
        gameInfo.classList.remove('collapsed');
    } else {
        gameInfo.classList.add('collapsed');
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === ',') {
        devMode = !devMode; 
        document.getElementById('devPanel').style.display = devMode ? 'block' : 'none';
    }
});

function predictTargetPosition(enemy, bulletSpeed, tower) {
    let dx = enemy.x - tower.x;
    let dy = enemy.y - tower.y;
    let distance = Math.sqrt(dx * dx + dy * dy);
    let timeToTarget = distance / bulletSpeed;

    let nextPathPoint = path[enemy.pathIndex];
    if (!nextPathPoint) return {x: enemy.x, y: enemy.y};

    let enemyDx = nextPathPoint.x - enemy.x;
    let enemyDy = nextPathPoint.y - enemy.y;
    let enemyDistance = Math.sqrt(enemyDx * enemyDx + enemyDy * enemyDy);
    
    let predictedX = enemy.x + (enemyDx / enemyDistance) * enemy.speed * timeToTarget;
    let predictedY = enemy.y + (enemyDy / enemyDistance) * enemy.speed * timeToTarget;

    let distanceToPredict = enemy.speed * timeToTarget;
    if (distanceToPredict > enemyDistance) {
        return {x: nextPathPoint.x, y: nextPathPoint.y};
    }

    return {x: predictedX, y: predictedY};
}

function drawPath() {
    ctx.beginPath();
    ctx.moveTo(path[0].x, path[0].y);
    for (let i = 1; i < path.length; i++) {
        ctx.lineTo(path[i].x, path[i].y);
    }
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 40;
    ctx.stroke();
}

function Enemy(x, y, type = 'normal') {
    this.x = x;
    this.y = y;
    this.type = type;

    if (this.type === 'normal') {
        this.health = Math.floor(50 * (1 + 0.08 * Math.log(wave + 1))) * enemyHealthModifier;
    } else if (this.type === 'fast') {
        this.health = Math.floor(30 * (1 + 0.06 * Math.log(wave + 1))) * enemyHealthModifier;
        this.speed = this.speed * enemySpeedModifier;
    } else if (this.type === 'tank') {
        this.health = Math.floor(100 * (1 + 0.1 * Math.log(wave + 1))) * enemyHealthModifier;
    } else if (this.type === 'fortified') {
        this.health = Math.floor(80 * (1 + 0.07 * Math.log(wave + 1))) * enemyHealthModifier;
        this.damageReduction = 0.5; // Add explicit damage reduction
    } else if (this.type === 'dodger') {
        this.health = Math.floor(40 * (1 + 0.05 * Math.log(wave + 1))) * enemyHealthModifier;
        this.speed = this.speed * enemySpeedModifier;
    }
    
    this.maxHealth = this.health;
    this.speed = 1;
    this.pathIndex = 0;
    this.isDead = false;

    if (this.type === 'fast') {
        this.health *= 0.5;
        this.maxHealth = this.health;
        this.speed = 2 * enemySpeedModifier;
    } else if (this.type === 'tank') {
        this.health *= 2;
        this.maxHealth = this.health;
        this.speed = 0.5;
    }

    this.update = function() {
        if (gamePaused || this.isDead) return false;
        let target = path[this.pathIndex];
        let dx = target.x - this.x;
        let dy = target.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < this.speed) {
            this.pathIndex++;
            if (this.pathIndex >= path.length) {
                lives--;
                enemiesToKill--;
                updateGameInfo();
                checkWaveCompletion();
                checkGameOver();
                return true;
            }
        } else {
            this.x += (dx / distance) * this.speed;
            this.y += (dy / distance) * this.speed;
        }
        return false;
    }

    this.draw = function() {
        if (this.isDead) return;
        let color;
        let size;
        switch(this.type) {
            case 'fast':
                color = 'yellow';
                size = 8;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - size);
                ctx.lineTo(this.x - size, this.y + size);
                ctx.lineTo(this.x + size, this.y + size);
                ctx.fillStyle = color;
                ctx.fill();
                break;
            case 'tank':
                color = 'purple';
                size = 15;
                ctx.fillStyle = color;
                ctx.fillRect(this.x - size, this.y - size, size * 2, size * 2);
                break;
            case 'fortified':
                color = 'orange';
                size = 12;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.setLineDash([4, 4]);
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.setLineDash([]);
                break;
            case 'dodger':
                color = 'cyan';
                size = 10;
                ctx.beginPath();
                ctx.moveTo(this.x + size, this.y);
                ctx.lineTo(this.x + size * Math.cos(2*Math.PI/12), this.y + size * Math.sin(2*Math.PI/12));
                ctx.lineTo(this.x + size * Math.cos(6*Math.PI/12), this.y + size * Math.sin(6*Math.PI/12));
                ctx.lineTo(this.x, this.y + size);
                ctx.lineTo(this.x - size * Math.cos(6*Math.PI/12), this.y + size * Math.sin(6*Math.PI/12));
                ctx.lineTo(this.x - size * Math.cos(2*Math.PI/12), this.y + size * Math.sin(2*Math.PI/12));
                ctx.lineTo(this.x - size, this.y);
                ctx.lineTo(this.x - size * Math.cos(2*Math.PI/12), this.y - size * Math.sin(2*Math.PI/12));
                ctx.lineTo(this.x - size * Math.cos(6*Math.PI/12), this.y - size * Math.sin(6*Math.PI/12));
                ctx.lineTo(this.x, this.y - size);
                ctx.lineTo(this.x + size * Math.cos(6*Math.PI/12), this.y - size * Math.sin(6*Math.PI/12));
                ctx.lineTo(this.x + size * Math.cos(2*Math.PI/12), this.y - size * Math.sin(2*Math.PI/12));
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                break;
            default:
                color = 'red';
                size = 10;
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();
        }
        ctx.fillStyle = 'black';
        ctx.fillRect(this.x - 15, this.y - 20, 30, 5);
        ctx.fillStyle = 'green';
        ctx.fillRect(this.x - 15, this.y - 20, (this.health / this.maxHealth) * 30, 5);
    }
}

function Tower(x, y, type) {
    this.x = x;
    this.y = y;
    this.type = type;
    this.level = 1;
    this.maxLevel = 10;
    this.specialization = null;
    this.canPierce = false;
    this.rotation = 0; 

    switch(type) {
        case 'basic':
            this.range = 120;
            this.damage = 30;
            this.cooldown = 500;
            this.cost = 50;
            this.upgradeCost = 50;
            break;
        case 'sniper':
            this.range = 250;
            this.damage = 120;
            this.cooldown = 2000;
            this.cost = 100;
            this.upgradeCost = 100;
            this.critChance = 0.1;
            break;
        case 'shotgun':
            this.range = 80;
            this.damage = 20;
            this.cooldown = 1000;
            this.cost = 75;
            this.upgradeCost = 75;
            this.bulletCount = 3;
            this.spreadAngle = Math.PI / 6;
            this.bulletCount = Math.floor(this.bulletCount);
            break;
        case 'alchemist':
            this.range = 150;
            this.damage = 0;
            this.cooldown = 1000;
            this.cost = 75;
            this.upgradeCost = 75;
            this.boostPercentage = 0.1;
            break;
        case 'factory': // Added case for Factory Tower
            this.range = 100; // Visible range indicator
            this.cashInterval = 5000; // Generate cash every 5 seconds
            this.lastCashTime = Date.now();
            break;
    }

    this.lastShot = 0;

    this.draw = function() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);

        ctx.fillStyle = this.type === 'basic' ? '#3498db' : 
                        (this.type === 'sniper' ? '#2ecc71' : 
                        (this.type === 'shotgun' ? '#e67e22' : 
                        (this.type === 'alchemist' ? '#8e44ad' : '#16a085'))); // Factory Tower color
        if (this.type === 'basic') {
            ctx.fillRect(-15, -15, 30, 30);
        } else if (this.type === 'sniper') {
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
        } else if (this.type === 'shotgun') {
            ctx.beginPath();
            ctx.moveTo(0, -15);
            ctx.lineTo(10, -8);
            ctx.lineTo(15, 0);
            ctx.lineTo(10, 8);
            ctx.lineTo(0, 15);
            ctx.lineTo(-10, 8);
            ctx.lineTo(-15, 0);
            ctx.lineTo(-10, -8);
            ctx.closePath();
            ctx.fill();
        } else if (this.type === 'alchemist') {
            ctx.save();
            ctx.translate(0, 0);
            ctx.rotate(Math.PI / 4);
            ctx.fillRect(-15, -15, 30, 30);
            ctx.restore();
        } else if (this.type === 'factory') { // Draw Factory Tower
            ctx.fillRect(-20, -10, 40, 20); // Base
            ctx.fillRect(-10, -25, 20, 15); // Top
        }

        ctx.restore();

        if (this === selectedTower) {
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 20, 0, Math.PI * 2);
            ctx.stroke();
        }

        if (this === selectedTower) {
            ctx.strokeStyle = 'rgba(46, 204, 113, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);
            ctx.stroke();
        }
    }

    this.shoot = function() {
        if (gamePaused) return;
        if (this.type === 'factory') return; // Factory doesn't shoot

        let now = Date.now();
        
        if (now - this.lastShot < this.cooldown) return;
        
        let target = null;
        let closestDistance = Infinity;

        for (let enemy of enemies) {
            if (enemy.isDead) continue;
            let dx = enemy.x - this.x;
            let dy = enemy.y - this.y;
            let distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance <= this.range && distance < closestDistance) {
                closestDistance = distance;
                target = enemy;
            }
        }

        if (target) {
            let bulletSpeed = 5;
            let predictedPos = predictTargetPosition(target, bulletSpeed, this);
            this.rotation = Math.atan2(predictedPos.y - this.y, predictedPos.x - this.x);
            
            let damage = this.boostedDamage || this.damage;
            if (this.type === 'shotgun') {
                let angleStep = this.spreadAngle / (this.bulletCount - 1);
                let startAngle = this.rotation - this.spreadAngle / 2;
                for (let i = 0; i < this.bulletCount; i++) {
                    let angle = startAngle + i * angleStep;
                    let bulletX = this.x + Math.cos(angle) * 15;
                    let bulletY = this.y + Math.sin(angle) * 15;
                    bullets.push(new Bullet(bulletX, bulletY, damage, angle, this.boostedRange || this.range, this.type));
                }
            } else {
                let bulletX = this.x;
                let bulletY = this.y;
                
                if (this.type === 'sniper') {
                    bulletX = this.x + Math.cos(this.rotation) * 15;
                    bulletY = this.y + Math.sin(this.rotation) * 15;
                }
                
                bullets.push(new Bullet(bulletX, bulletY, damage, 0, this.boostedRange || this.range, this.type, target, this, predictedPos));
            }
            this.lastShot = now;
        }
    }

    this.update = function() {
        if (gamePaused || this.isDead) return false;

        if (this.type === 'factory') {
            let now = Date.now();
            if (now - this.lastCashTime >= this.cashInterval) {
                money += 10; // Amount of cash generated per interval
                updateGameInfo();
                this.lastCashTime = now;
            }
            return false; // Factories don't affect enemy movement
        }

        // Existing update logic...
        // (Keep the existing enemy movement logic)
    }

    this.upgrade = function() {
        if (this.type === 'factory') {
            // Factory towers do not have upgrades
            return;
        }

        if (this.level < this.maxLevel && money >= this.upgradeCost) {
            money -= this.upgradeCost;
            this.level++;
            if (this.type === 'factory') {
                this.cashInterval = Math.max(1000, this.cashInterval - 500); // Decrease interval down to 1 second
            } else {
                this.damage += this.damage * 0.1;
                this.range += this.range * 0.05;
                this.cooldown *= 0.95;
            }
            this.upgradeCost = Math.floor(this.upgradeCost * 1.5);

            if (this.type === 'sniper') {
                if (this.level === 5 && !this.specialization) {
                    document.getElementById('sniperUpgradeModal').style.display = 'block';
                    return;
                }
                this.critChance += 0.05;
            } else if (this.type === 'shotgun' && this.level % 3 === 0) {
                this.bulletCount++;
                this.bulletCount = Math.floor(this.bulletCount);
            } else if (this.type === 'basic' && this.level === 5 && !this.specialization) {
                document.getElementById('basicUpgradeModal').style.display = 'block';
                return;
            } else if (this.type === 'shotgun' && this.level === 5 && !this.specialization) {
                document.getElementById('shotgunUpgradeModal').style.display = 'block';
                return;
            } else if (this.type === 'alchemist' && this.level === 5 && !this.specialization) {
                document.getElementById('alchemistUpgradeModal').style.display = 'block';
                return;
            }

            updateTowerInfo();
        }
    }

    this.specialize = function(type) {
        this.specialization = type;
        
        if (this.type === 'shotgun') {
            if (type === 'spread') {
                this.spreadAngle *= 1.5; 
                this.damage *= 0.8;
            } else if (type === 'slug') { 
                this.damage *= 1.5;
                this.bulletCount *= 0.8;
                this.bulletCount = Math.max(1, Math.floor(this.bulletCount));
            }
        }
    }

    this.applyBoost = function(tower) {
        if (this.type === 'alchemist') {
            let dx = tower.x - this.x;
            let dy = tower.y - this.y;
            let distance = Math.sqrt(dx*dx + dy*dy);
            
            if (distance <= this.range && tower.type !== 'alchemist') {
                tower.boostedDamage = tower.damage * (1 + this.boostPercentage);
                tower.boostedRange = tower.range * (1 + this.boostPercentage);
            }
        }
    }

    this.sellTower = function() {
        let sellValue = Math.floor((this.cost + (this.level - 1) * this.upgradeCost) * 0.5);
        return sellValue;
    }
}

function Bullet(x, y, damage, angle, range, type, target = null, tower = null, predictedPos = null) {
    this.x = x;
    this.y = y;
    this.damage = damage;
    this.speed = 5;
    this.angle = angle;
    this.range = range;
    this.distanceTraveled = 0;
    this.type = type;
    this.target = target;
    this.canPierce = type === 'laser';
    this.tower = tower;
    this.predictedPos = predictedPos;

    if (this.type === 'shotgun' || !this.target || this.target.isDead) {
        this.vx = Math.cos(this.angle) * this.speed;
        this.vy = Math.sin(this.angle) * this.speed;
    } else {
        let targetX = this.predictedPos ? this.predictedPos.x : this.target.x;
        let targetY = this.predictedPos ? this.predictedPos.y : this.target.y;
        let dx = targetX - this.x;
        let dy = targetY - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        this.vx = (dx / distance) * this.speed;
        this.vy = (dy / distance) * this.speed;
    }
}

Bullet.prototype.update = function() {
    if (gamePaused) return false; 

    this.x += this.vx;
    this.y += this.vy;
    this.distanceTraveled += this.speed;

    if (this.distanceTraveled >= this.range) {
        return true; 
    }

    for (let enemy of enemies) {
        if (enemy.isDead) continue;
        let distance = Math.sqrt((enemy.x - this.x)**2 + (enemy.y - this.y)**2);
        if (distance < 10) {
            if (enemy.type === 'dodger' && Math.random() < enemy.dodgeChance) {
                continue; 
            }
            let damageDealt = this.damage;
            if (enemy.type === 'fortified') {
                damageDealt *= (1 - enemy.damageReduction);
            }
            enemy.health -= damageDealt;
            if (enemy.health <= 0 && !enemy.isDead) {
                enemy.isDead = true;
                money += Math.floor(10 * Math.sqrt(wave));
                enemiesToKill--;
                updateGameInfo();
                checkWaveCompletion();
            }
            if (!this.canPierce) {
                return true; 
            }
        }
    }
    return false; 
}

Bullet.prototype.draw = function() {
    ctx.fillStyle = (this.type === 'sniper' || this.type === 'sharpshooter') ? '#2ecc71' :
                    (this.type === 'laser') ? '#f1c40f' :
                    (this.type === 'shotgun' || this.type === 'slug') ? '#e67e22' :
                    (this.type === 'basic' || this.type === 'rapidfire' || this.type === 'heavy') ? '#3498db' :
                    '#ffffff'; 
    ctx.beginPath();
    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
    ctx.fill();
};

canvas.addEventListener('mousemove', function(event) {
    let rect = canvas.getBoundingClientRect();
    mouseX = event.clientX - rect.left;
    mouseY = event.clientY - rect.top;
});

canvas.addEventListener('click', function(event) {
    if (gameOver) return;

    let rect = canvas.getBoundingClientRect();
    let x = event.clientX - rect.left;
    let y = event.clientY - rect.top;

    if (placingTower) {
        if (!isOnPath(x, y) && !isTowerOverlap(x, y) && money >= getTowerCost(placingTower)) {
            let newTower = new Tower(x, y, placingTower);
            towers.push(newTower);
            money -= getTowerCost(placingTower);
            selectedTower = newTower; 
            updateTowerInfo();
            placingTower = null;
        } else {
            if (money < getTowerCost(placingTower)) {
                placingTower = null;
            }
        }
    } else {
        let clickedTower = towers.find(tower => 
            x >= tower.x - 15 && x <= tower.x + 15 &&
            y >= tower.y - 15 && y <= tower.y + 15
        );

        selectedTower = clickedTower || null;
        updateTowerInfo();
    }
});

document.getElementById('basicTower').addEventListener('click', function() {
    if (placingTower === 'basic') {
        placingTower = null; 
    } else {
        placingTower = 'basic';
    }
});

document.getElementById('sniperTower').addEventListener('click', function() {
    if (placingTower === 'sniper') {
        placingTower = null; 
    } else {
        placingTower = 'sniper';
    }
});

document.getElementById('shotgunTower').addEventListener('click', function() {
    if (placingTower === 'shotgun') {
        placingTower = null; 
    } else {
        placingTower = 'shotgun';
    }
});

document.getElementById('alchemistTower').addEventListener('click', function() {
    if (placingTower === 'alchemist') {
        placingTower = null; 
    } else {
        placingTower = 'alchemist';
    }
});

document.getElementById('factoryTower').addEventListener('click', function() {
    if (placingTower === 'factory') {
        placingTower = null; 
    } else {
        placingTower = 'factory';
    }
});

function spawnWave() {
    if (gameOver) return;

    gamePaused = false;
    document.getElementById('startWave').style.display = 'none';
    
    const gameInfo = document.getElementById('gameInfo');
    gameInfo.classList.remove('force-show');
    
    enemiesToKill = totalEnemiesToSpawn;
    enemiesSpawned = 0;
    
    updateEnemyHealth();

    enemySpawnInterval = setInterval(() => {
        if (enemiesSpawned < totalEnemiesToSpawn) {
            let enemyType = 'normal';
            if (wave >= 5) {
                let rand = Math.random();
                if (rand < 0.2) {
                    enemyType = 'fast';
                } else if (rand < 0.3) {
                    enemyType = 'tank';
                } else if (rand < 0.5) {
                    enemyType = 'fortified';
                } else {
                    enemyType = 'dodger';
                }
            }
            enemies.push(new Enemy(path[0].x, path[0].y, enemyType)); // Spawn enemy at first path point
            enemiesSpawned++;
        } else {
            clearInterval(enemySpawnInterval);
        }
    }, 1000);
    
    updateGameInfo();
}

function updateEnemyHealth() {
    document.getElementById('normalEnemyHealth').textContent = Math.floor(50 * (1 + 0.08 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('fastEnemyHealth').textContent = Math.floor(30 * (1 + 0.06 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('tankEnemyHealth').textContent = Math.floor(100 * (1 + 0.1 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('fortifiedEnemyHealth').textContent = Math.floor(80 * (1 + 0.07 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('dodgerEnemyHealth').textContent = Math.floor(40 * (1 + 0.05 * Math.log(wave + 1))) * enemyHealthModifier;
    
    document.getElementById('normalEnemyCurrentHealth').textContent = Math.floor(50 * (1 + 0.08 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('fastEnemyCurrentHealth').textContent = Math.floor(30 * (1 + 0.06 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('tankEnemyCurrentHealth').textContent = Math.floor(100 * (1 + 0.1 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('fortifiedEnemyCurrentHealth').textContent = Math.floor(80 * (1 + 0.07 * Math.log(wave + 1))) * enemyHealthModifier;
    document.getElementById('dodgerEnemyCurrentHealth').textContent = Math.floor(40 * (1 + 0.05 * Math.log(wave + 1))) * enemyHealthModifier;
}

document.getElementById('startWave').addEventListener('click', function() {
    const gameInfo = document.getElementById('gameInfo');
    gameInfo.classList.add('force-show');
    spawnWave();
});

function updateGameInfo() {
    document.getElementById('money').textContent = Math.floor(money);
    document.getElementById('lives').textContent = lives;
    document.getElementById('wave').textContent = wave;
    document.getElementById('enemiesToKill').textContent = enemiesToKill;
}

function showWaveMessage() {
    let waveMessage = document.getElementById('waveMessage');
    waveMessage.textContent = 'Wave ' + wave + ' completed!';
    waveMessage.style.opacity = '1';
    setTimeout(() => {
        waveMessage.style.opacity = '0';
    }, 3000);
}

function checkWaveCompletion() {
    if (enemiesToKill <= 0) {
        wave++;
        totalEnemiesToSpawn = wave + 9; 
        showWaveMessage();
        const startWaveButton = document.getElementById('startWave');
        startWaveButton.style.display = 'block';
        gamePaused = true;
        
        bullets = []; 
        
        const gameInfo = document.getElementById('gameInfo');
        gameInfo.classList.remove('force-show');
    }
}

function checkGameOver() {
    if (lives <= 0 && !infiniteLives) {
        gameOver = true;
        showGameOverMessage();
    }
}

function showGameOverMessage() {
    document.getElementById('gameOverMessage').style.display = 'block';
}

function hideGameOverMessage() {
    document.getElementById('gameOverMessage').style.display = 'none';
}

function updateTowerInfo() {
    const towerInfo = document.getElementById('towerInfo');
    if (!towerInfo) return; 

    if (selectedTower) {
        towerInfo.style.display = 'block';
        
        const elements = {
            type: document.getElementById('towerType'),
            damage: document.getElementById('towerDamage'),
            range: document.getElementById('towerRange'),
            cooldown: document.getElementById('towerCooldown'),
            level: document.getElementById('towerLevel'),
            special: document.getElementById('towerSpecial'),
            upgradeCost: document.getElementById('towerUpgradeCost'),
            upgradeButton: document.getElementById('upgradeTower'),
            maxLevelMsg: document.getElementById('maxLevelMessage')
        };

        if (elements.type) elements.type.textContent = selectedTower.type.charAt(0).toUpperCase() + selectedTower.type.slice(1);
        if (elements.damage) {
            if(selectedTower.type === 'factory') {
                elements.damage.textContent = 'N/A';
            } else {
                elements.damage.textContent = Math.round(selectedTower.damage);
            }
        }
        if (elements.range) elements.range.textContent = Math.round(selectedTower.range);
        if (elements.cooldown) {
            if(selectedTower.type === 'factory') {
                elements.cooldown.textContent = 'N/A';
            } else {
                elements.cooldown.textContent = (selectedTower.cooldown / 1000).toFixed(2);
            }
        }
        if (elements.level) elements.level.textContent = selectedTower.level;
        
        let specialInfo = '';
        if (selectedTower.type === 'sniper') {
            specialInfo = `Crit Chance: ${Math.round(selectedTower.critChance * 100)}%`;
        } else if (selectedTower.type === 'shotgun') {
            specialInfo = `Bullet Count: ${Math.round(selectedTower.bulletCount)}, Spread Angle: ${Math.round(selectedTower.spreadAngle * 180 / Math.PI)}Â°`;
        } else if (selectedTower.type === 'alchemist') {
            specialInfo = `Boost: ${Math.round(selectedTower.boostPercentage * 100)}%`;
        } else if (selectedTower.type === 'factory') {
            specialInfo = `Generates: $10 every ${selectedTower.cashInterval / 1000} seconds`;
        }
        
        if (selectedTower.specialization) {
            specialInfo += `, Specialization: ${selectedTower.specialization}`;
        }
        
        if (elements.special) elements.special.textContent = specialInfo;
        if (elements.upgradeCost) {
            if(selectedTower.type === 'factory') {
                elements.upgradeCost.textContent = 'N/A';
                elements.upgradeButton.style.display = 'none';
            } else {
                elements.upgradeCost.textContent = selectedTower.upgradeCost;
            }
        }
        
        if (elements.upgradeButton && selectedTower.type !== 'factory') {
            const modals = document.querySelectorAll('.tower-upgrade-modal');
            const anyModalOpen = Array.from(modals).some(modal => modal.style.display === 'block');
            if (anyModalOpen) {
                elements.upgradeButton.disabled = true;
            } else {
                elements.upgradeButton.style.display = 'block';
                elements.upgradeButton.disabled = money < selectedTower.upgradeCost;
                if (elements.upgradeButton.disabled) {
                    elements.upgradeButton.title = `Need ${selectedTower.upgradeCost - money} more money to upgrade`;
                } else {
                    elements.upgradeButton.title = '';
                }
            }
        } else {
            elements.upgradeButton.style.display = 'none';
        }
        
        if (elements.maxLevelMsg) {
            elements.maxLevelMsg.style.display = selectedTower.level >= selectedTower.maxLevel ? 'block' : 'none';
        }
    } else {
        towerInfo.style.display = 'none';
    }
}

function updateGame() {
    if (gameOver) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    drawPath();
    
    enemies = enemies.filter(enemy => {
        if (!enemy.isDead) {
            let reachedEnd = enemy.update();
            enemy.draw();
            return !reachedEnd;
        }
        return false;
    });
    
    towers.forEach(tower => {
        tower.update(); // Ensure Factory's update is called
        tower.draw();
        tower.shoot();
    });
    
    bullets = bullets.filter(bullet => {
        let hit = bullet.update();
        bullet.draw();
        return !hit;
    });
    
    if (placingTower) {
        ctx.globalAlpha = 0.5;
        let tower = new Tower(mouseX, mouseY, placingTower);
        tower.draw();
        ctx.beginPath();
        ctx.arc(mouseX, mouseY, tower.range, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.stroke();
        ctx.globalAlpha = 1;
    }
    
    if (selectedTower) {
        updateTowerInfo();
    }
    
    updateGameInfo();
    requestAnimationFrame(updateGame);
}

function restartGame() {
    money = 100;
    lives = 20;
    wave = 1;
    enemies = [];
    towers = [];
    bullets = [];
    selectedTower = null;
    gamePaused = true;
    gameOver = false;
    enemiesSpawned = 0;
    enemiesToKill = 10;
    totalEnemiesToSpawn = 10;

    clearInterval(enemySpawnInterval);
    
    const gameInfo = document.getElementById('gameInfo');
    gameInfo.classList.remove('collapsed');
    gameInfo.classList.remove('force-show');
    
    hideGameOverMessage();
    document.getElementById('startWave').style.display = 'block';
    document.getElementById('difficultySelectionMenu').style.display = 'block';
    updateGameInfo();
}

document.getElementById('restartButton').addEventListener('click', restartGame);
document.getElementById('playAgainButton').addEventListener('click', restartGame);

document.getElementById('enemyInfoButton').addEventListener('click', function() {
    document.getElementById('enemyInfo').style.display = 'block';
});

document.querySelector('#enemyInfo .close-button').addEventListener('click', function() {
    document.getElementById('enemyInfo').style.display = 'none';
});

document.getElementById('laserUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'sniper') {
        selectedTower.specialize('laser');
        document.getElementById('sniperUpgradeModal').style.display = 'none';
        updateTowerInfo();
    }
});

document.getElementById('sharpshooterUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'sniper') {
        selectedTower.specialize('sharpshooter');
        document.getElementById('sniperUpgradeModal').style.display = 'none';
        updateTowerInfo();
    }
});

document.getElementById('rapidfireUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'basic') {
        selectedTower.specialize('rapidfire'); 
        document.getElementById('basicUpgradeModal').style.display = 'none';
        updateTowerInfo();
    }
});

document.getElementById('heavyUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'basic') {
        selectedTower.specialize('heavy');
        document.getElementById('basicUpgradeModal').style.display = 'none'; 
        updateTowerInfo();
    } 
});

document.getElementById('spreadUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'shotgun') {
        selectedTower.specialize('spread');
        document.getElementById('shotgunUpgradeModal').style.display = 'none';
        updateTowerInfo();  
    }
});

document.getElementById('slugUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'shotgun') {
        selectedTower.specialize('slug'); 
        document.getElementById('shotgunUpgradeModal').style.display = 'none';
        updateTowerInfo();
    }
});

document.getElementById('stimulantUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'alchemist') {
        selectedTower.specialize('stimulant'); 
        document.getElementById('alchemistUpgradeModal').style.display = 'none'; 
        updateTowerInfo();
    } 
});

document.getElementById('radiusUpgrade').addEventListener('click', function() {
    if (selectedTower && selectedTower.type === 'alchemist') {
        selectedTower.specialize('radius');
        document.getElementById('alchemistUpgradeModal').style.display = 'none';
        updateTowerInfo();
    }
});

const setMoneyButton = document.getElementById('setMoneyButton');
if (setMoneyButton) {
    setMoneyButton.addEventListener('click', () => {
        money = parseInt(document.getElementById('setMoney').value);
        updateGameInfo();
    });
}

const setLivesButton = document.getElementById('setLivesButton');
if (setLivesButton) {
    setLivesButton.addEventListener('click', () => {
        lives = parseInt(document.getElementById('setLives').value);
        updateGameInfo();
    });
}

const setWaveButton = document.getElementById('setWaveButton');
if (setWaveButton) {
    setWaveButton.addEventListener('click', () => {
        wave = parseInt(document.getElementById('setWave').value);
        updateGameInfo();
    });
}

document.getElementById('toggleInfiniteLives').addEventListener('click', function() {
    infiniteLives = !infiniteLives;
    this.style.backgroundColor = infiniteLives ? '#27ae60' : '#34495e';
    if (infiniteLives) {
        lives = Infinity;
        updateGameInfo();
    } else {
        lives = 20;
        updateGameInfo();
    }
});

document.getElementById('skipWave').addEventListener('click', () => {
    enemies = [];
    enemiesToKill = 0;
    checkWaveCompletion();
});

document.getElementById('upgradeAllTowers').addEventListener('click', () => {
    towers.forEach(tower => {
        while (tower.level < tower.maxLevel) {
            tower.upgrade();
        }
    });
});

document.getElementById('closeDevPanel').addEventListener('click', () => {
    document.getElementById('devPanel').style.display = 'none';
    devMode = false; 
});

const upgradeTowerButton = document.getElementById('upgradeTower');
if (upgradeTowerButton) {
    upgradeTowerButton.addEventListener('click', function() {
        const modals = document.querySelectorAll('.tower-upgrade-modal');
        const anyModalOpen = Array.from(modals).some(modal => modal.style.display === 'block');
        if (anyModalOpen) {
            return;
        }
        if (selectedTower && !gameOver) {
            selectedTower.upgrade();
            updateTowerInfo();
            updateGameInfo();
        }
    });
}

const sellTowerButton = document.getElementById('sellTower');
if (sellTowerButton) {
    sellTowerButton.addEventListener('click', function() {
        if (selectedTower && !gameOver) {
            let sellValue = selectedTower.sellTower();
            money += sellValue;
            towers = towers.filter(tower => tower !== selectedTower);
            selectedTower = null;
            updateTowerInfo();
            updateGameInfo();
        }
    });
}

document.getElementById('easyDifficulty').addEventListener('click', function() {
    difficulty = 'easy';
    enemySpeedModifier = 0.8;
    enemyHealthModifier = 0.9;
    towerCost
Modifier = 0.9;
    document.getElementById('difficultySelectionMenu').style.display = 'none';
    document.getElementById('mapSelectionMenu').style.display = 'block';
    updateTowerCosts();
});

document.getElementById('normalDifficulty').addEventListener('click', function() {
    difficulty = 'normal';
    enemySpeedModifier = 1;
    enemyHealthModifier = 1;
    towerCostModifier = 1;
    document.getElementById('difficultySelectionMenu').style.display = 'none';
    document.getElementById('mapSelectionMenu').style.display = 'block';
    updateTowerCosts();
});

document.getElementById('hardDifficulty').addEventListener('click', function() {
    difficulty = 'hard';
    enemySpeedModifier = 1.2;
    enemyHealthModifier = 1.1;
    towerCostModifier = 1.1;
    document.getElementById('difficultySelectionMenu').style.display = 'none';
    document.getElementById('mapSelectionMenu').style.display = 'block';
    updateTowerCosts();
});

function selectMap(mapId) {
    // Set the selected map
    switch (mapId) {
        case 'map1':
            path = [
                {x: 0, y: 100},
                {x: 700, y: 100},
                {x: 700, y: 500},
                {x: 100, y: 500},
                {x: 100, y: 300},
                {x: 800, y: 300}
            ];
            break;
        case 'map2':
            path = [
                {x: 0, y: 300},
                {x: 400, y: 300},
                {x: 400, y: 100},
                {x: 800, y: 100},
                {x: 800, y: 500},
                {x: 400, y: 500},
                {x: 400, y: 300},
                {x: 800, y: 300}
            ];
            break;
        case 'map3':
            path = [
                {x: 0, y: 100},
                {x: 200, y: 100},
                {x: 200, y: 500},
                {x: 600, y: 500},
                {x: 600, y: 100},
                {x: 800, y: 100}
            ];
            break;
    }

    document.getElementById('mapSelectionMenu').style.display = 'none';
}

document.getElementById('map1').addEventListener('click', function() {
    selectMap('map1');
});

document.getElementById('map2').addEventListener('click', function() {
    selectMap('map2');
});

document.getElementById('map3').addEventListener('click', function() {
    selectMap('map3');
});

document.getElementById('pauseButton').addEventListener('click', function() {
    gamePaused = !gamePaused;
    if (gamePaused) {
        this.textContent = 'Resume';
    } else {
        this.textContent = 'Pause';
    }
});

updateGame();
</script>
</body></html>